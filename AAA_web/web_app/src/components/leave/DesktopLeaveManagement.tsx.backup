import React, { useState, useEffect } from 'react';
import {
  Box,
  Typography,
  Card,
  CardContent,
  Button,
  IconButton,
  Grid,
  Chip,
  LinearProgress,
  CircularProgress,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  Tooltip,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  FormControlLabel,
  Checkbox,
  Alert,
  Divider,
  Pagination,
  Stack,
} from '@mui/material';
import {
  Event as EventIcon,
  Schedule as ScheduleIcon,
  CheckCircle as CheckCircleIcon,
  Cancel as CancelIcon,
  Assignment as AssignmentIcon,
  EditCalendar as EditCalendarIcon,
  Visibility as VisibilityIcon,
  VisibilityOff as VisibilityOffIcon,
  AdminPanelSettings as AdminPanelSettingsIcon,
  Pending as PendingIcon,
  CalendarMonth as CalendarMonthIcon,
  Add as AddIcon,
  ArrowBack as ArrowBackIcon,
  Fullscreen as FullscreenIcon,
  Menu as MenuIcon,
  ChevronLeft as ChevronLeftIcon,
  ChevronRight as ChevronRightIcon,
  PeopleAltOutlined as PeopleIcon,
  FormatListNumbered as SequentialIcon,
} from '@mui/icons-material';
import { DatePicker } from '@mui/x-date-pickers/DatePicker';
import { LocalizationProvider } from '@mui/x-date-pickers/LocalizationProvider';
import { AdapterDayjs } from '@mui/x-date-pickers/AdapterDayjs';
import dayjs from 'dayjs';
import type {
  LeaveManagementData,
  LeaveRequestRequest,
  LeaveCancelRequest,
  YearlyDetail,
  Approver,
  LeaveRequestApprovalLine,
} from '../../types/leave';
import leaveService from '../../services/leaveService';
import authService from '../../services/authService';
import PersonalCalendar from '../calendar/PersonalCalendar';
import TotalCalendar from '../calendar/TotalCalendar';
import { useNavigate } from 'react-router-dom';
import ApproverSelectionModal from './ApproverSelectionModal';
import ReferenceSelectionModal from './ReferenceSelectionModal';
import LeaveRequestModal from './LeaveRequestModal';
import { useThemeStore } from '../../store/themeStore';

interface DesktopLeaveManagementProps {
  leaveData: LeaveManagementData;
  onRefresh: () => void;
}

export default function DesktopLeaveManagement({
  leaveData,
  onRefresh,
}: DesktopLeaveManagementProps) {
  const navigate = useNavigate();
  const { colorScheme } = useThemeStore();
  const isDark = colorScheme.name === 'Dark';
  const [requestDialogOpen, setRequestDialogOpen] = useState(false);
  const [hideCanceled, setHideCanceled] = useState(false);
  const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
  const [totalCalendarOpen, setTotalCalendarOpen] = useState(false);
  const [detailPanelOpen, setDetailPanelOpen] = useState(false);
  const [selectedLeaveDetail, setSelectedLeaveDetail] = useState<YearlyDetail | null>(null);
  const [managementTableDialogOpen, setManagementTableDialogOpen] = useState(false);
  const [sidebarOpen, setSidebarOpen] = useState(false); // ì‚¬ì´ë“œë°” ì—´ë¦¼/ë‹«í˜ ìƒíƒœ (ë””í´íŠ¸: ë‹«í˜)

  // ê°œì¸ë³„ íœ´ê°€ ë‚´ì—­ í˜ì´ì§€ë„¤ì´ì…˜
  const [currentPage, setCurrentPage] = useState(1);
  const itemsPerPage = 10;
  
  // ì—°ë„ë³„ íœ´ê°€ ë‚´ì—­ (í•„í„°ë§ëœ ë°ì´í„°)
  const [yearlyDetails, setYearlyDetails] = useState(leaveData.yearlyDetails || []);
  const [yearlyLoading, setYearlyLoading] = useState(false);
  
  // ì—°ë„ë³„ íœ´ê°€ í˜„í™© (íœ´ê°€ ê´€ë¦¬ ëŒ€ì¥ìš©)
  const [yearlyWholeStatus, setYearlyWholeStatus] = useState(leaveData.yearlyWholeStatus || []);
  
  // íœ´ê°€ ê´€ë¦¬ ëŒ€ì¥ ë°ì´í„° (yearlyWholeStatusì—ì„œ ë³€í™˜)
  const [managementTableData, setManagementTableData] = useState<any[]>([]);
  const [tableLoading, setTableLoading] = useState(false);

  // íœ´ê°€ ì‹ ì²­ í¼ ìƒíƒœ
  const [requestForm, setRequestForm] = useState({
    leaveType: '',
    startDate: dayjs(),
    endDate: dayjs(),
    reason: '',
    halfDaySlot: '',
    approverIds: [] as string[],
    ccList: [] as Array<{ name: string; department: string }>,
    useHalfDay: false,
    useNextYearLeave: false,
  });

  // ëª¨ë‹¬ ìƒíƒœ
  const [approverModalOpen, setApproverModalOpen] = useState(false);
  const [referenceModalOpen, setReferenceModalOpen] = useState(false);
  const [isSequentialApproval, setIsSequentialApproval] = useState(false); // ìˆœì°¨ê²°ì¬ ëª¨ë“œ
  const [cancelRequestModalOpen, setCancelRequestModalOpen] = useState(false);
  const [cancelRequestLeave, setCancelRequestLeave] = useState<YearlyDetail | null>(null);
  const [approverList, setApproverList] = useState<Approver[]>([]); // ìŠ¹ì¸ì ëª©ë¡ (ì´ë¦„ í‘œì‹œìš©)

  // ìŠ¹ì¸ì ëª©ë¡ ë¡œë“œ (API 404 ì—ëŸ¬ë¡œ ì¸í•´ ì„ì‹œ ë¹„í™œì„±í™”)
  // useEffect(() => {
  //   const loadApprovers = async () => {
  //     try {
  //       const response = await leaveService.getApproverList();
  //       if (!response.error && response.approverList) {
  //         setApproverList(response.approverList);
  //       }
  //     } catch (err) {
  //       console.error('ìŠ¹ì¸ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', err);
  //     }
  //   };
  //   loadApprovers();
  // }, []);

  // ì´ˆê¸° ë¡œë“œ ì‹œ yearlyWholeStatusë¥¼ managementTableDataë¡œ ë³€í™˜
  useEffect(() => {
    if (leaveData.yearlyWholeStatus && leaveData.yearlyWholeStatus.length > 0) {
      const tableData = leaveData.yearlyWholeStatus
        .filter((item: any) => item.leaveType !== 'ì´ê³„')
        .map((item: any) => ({
          leaveType: item.leaveType || '',
          allowedDays: item.totalDays || 0,
          usedByMonth: [
            item.m01 || 0,
            item.m02 || 0,
            item.m03 || 0,
            item.m04 || 0,
            item.m05 || 0,
            item.m06 || 0,
            item.m07 || 0,
            item.m08 || 0,
            item.m09 || 0,
            item.m10 || 0,
            item.m11 || 0,
            item.m12 || 0,
          ],
          totalUsed: [
            item.m01 || 0,
            item.m02 || 0,
            item.m03 || 0,
            item.m04 || 0,
            item.m05 || 0,
            item.m06 || 0,
            item.m07 || 0,
            item.m08 || 0,
            item.m09 || 0,
            item.m10 || 0,
            item.m11 || 0,
            item.m12 || 0,
          ].reduce((sum: number, val: number) => sum + val, 0),
        }));
      setManagementTableData(tableData);
      setYearlyWholeStatus(leaveData.yearlyWholeStatus);
    }
  }, [leaveData.yearlyWholeStatus]);

  // ì—°ë„ ë³€ê²½ ì‹œ ì—°ë„ë³„ íœ´ê°€ ë‚´ì—­ ì¡°íšŒ
  useEffect(() => {
    loadYearlyLeaveData(selectedYear);
    loadManagementTable(selectedYear);
  }, [selectedYear]);

  // ì—°ë„ë³„ íœ´ê°€ ë‚´ì—­ ì¡°íšŒ
  const loadYearlyLeaveData = async (year: number) => {
    try {
      setYearlyLoading(true);
      const user = authService.getCurrentUser();
      if (!user) return;

      console.log('ì—°ë„ë³„ íœ´ê°€ ë‚´ì—­ ì¡°íšŒ:', year);
      
      const response = await leaveService.getYearlyLeave({
        userId: user.userId,
        year: year,
      });
      
      console.log('ì—°ë„ë³„ íœ´ê°€ ë‚´ì—­ ì‘ë‹µ:', response);
      
      if (response.yearlyDetails) {
        setYearlyDetails(response.yearlyDetails);
      } else {
        // API ì‘ë‹µì´ ì—†ìœ¼ë©´ ê¸°ì¡´ ë°ì´í„°ì—ì„œ í•„í„°ë§
        const filtered = leaveData.yearlyDetails.filter(detail => {
          const detailYear = new Date(detail.startDate).getFullYear();
          return detailYear === year;
        });
        setYearlyDetails(filtered);
      }
      
      // yearlyWholeStatus ì—…ë°ì´íŠ¸ (íœ´ê°€ ê´€ë¦¬ ëŒ€ì¥ìš©)
      if (response.yearlyWholeStatus && response.yearlyWholeStatus.length > 0) {
        setYearlyWholeStatus(response.yearlyWholeStatus);
        // yearlyWholeStatusë¥¼ managementTableData í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        const tableData = response.yearlyWholeStatus
          .filter((item: any) => item.leaveType !== 'ì´ê³„')
          .map((item: any) => ({
            leaveType: item.leaveType || '',
            allowedDays: item.totalDays || 0,
            usedByMonth: [
              item.m01 || 0,
              item.m02 || 0,
              item.m03 || 0,
              item.m04 || 0,
              item.m05 || 0,
              item.m06 || 0,
              item.m07 || 0,
              item.m08 || 0,
              item.m09 || 0,
              item.m10 || 0,
              item.m11 || 0,
              item.m12 || 0,
            ],
            totalUsed: [
              item.m01 || 0,
              item.m02 || 0,
              item.m03 || 0,
              item.m04 || 0,
              item.m05 || 0,
              item.m06 || 0,
              item.m07 || 0,
              item.m08 || 0,
              item.m09 || 0,
              item.m10 || 0,
              item.m11 || 0,
              item.m12 || 0,
            ].reduce((sum: number, val: number) => sum + val, 0),
          }));
        setManagementTableData(tableData);
      } else if (leaveData.yearlyWholeStatus && leaveData.yearlyWholeStatus.length > 0) {
        // API ì‘ë‹µì´ ì—†ìœ¼ë©´ ê¸°ì¡´ ë°ì´í„° ì‚¬ìš©
        setYearlyWholeStatus(leaveData.yearlyWholeStatus);
        const tableData = leaveData.yearlyWholeStatus
          .filter((item: any) => item.leaveType !== 'ì´ê³„')
          .map((item: any) => ({
            leaveType: item.leaveType || '',
            allowedDays: item.totalDays || 0,
            usedByMonth: [
              item.m01 || 0,
              item.m02 || 0,
              item.m03 || 0,
              item.m04 || 0,
              item.m05 || 0,
              item.m06 || 0,
              item.m07 || 0,
              item.m08 || 0,
              item.m09 || 0,
              item.m10 || 0,
              item.m11 || 0,
              item.m12 || 0,
            ],
            totalUsed: [
              item.m01 || 0,
              item.m02 || 0,
              item.m03 || 0,
              item.m04 || 0,
              item.m05 || 0,
              item.m06 || 0,
              item.m07 || 0,
              item.m08 || 0,
              item.m09 || 0,
              item.m10 || 0,
              item.m11 || 0,
              item.m12 || 0,
            ].reduce((sum: number, val: number) => sum + val, 0),
          }));
        setManagementTableData(tableData);
      }
    } catch (err: any) {
      console.error('ì—°ë„ë³„ íœ´ê°€ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨:', err);
      // ì—ëŸ¬ ë°œìƒ ì‹œ ê¸°ì¡´ ë°ì´í„°ì—ì„œ í•„í„°ë§
      const filtered = leaveData.yearlyDetails.filter(detail => {
        const detailYear = new Date(detail.startDate).getFullYear();
        return detailYear === selectedYear;
      });
      setYearlyDetails(filtered);
      
      // yearlyWholeStatusë„ ê¸°ì¡´ ë°ì´í„° ì‚¬ìš©
      if (leaveData.yearlyWholeStatus && leaveData.yearlyWholeStatus.length > 0) {
        setYearlyWholeStatus(leaveData.yearlyWholeStatus);
        const tableData = leaveData.yearlyWholeStatus
          .filter((item: any) => item.leaveType !== 'ì´ê³„')
          .map((item: any) => ({
            leaveType: item.leaveType || '',
            allowedDays: item.totalDays || 0,
            usedByMonth: [
              item.m01 || 0,
              item.m02 || 0,
              item.m03 || 0,
              item.m04 || 0,
              item.m05 || 0,
              item.m06 || 0,
              item.m07 || 0,
              item.m08 || 0,
              item.m09 || 0,
              item.m10 || 0,
              item.m11 || 0,
              item.m12 || 0,
            ],
            totalUsed: [
              item.m01 || 0,
              item.m02 || 0,
              item.m03 || 0,
              item.m04 || 0,
              item.m05 || 0,
              item.m06 || 0,
              item.m07 || 0,
              item.m08 || 0,
              item.m09 || 0,
              item.m10 || 0,
              item.m11 || 0,
              item.m12 || 0,
            ].reduce((sum: number, val: number) => sum + val, 0),
          }));
        setManagementTableData(tableData);
      }
    } finally {
      setYearlyLoading(false);
    }
  };

  // íœ´ê°€ ê´€ë¦¬ ëŒ€ì¥ ë°ì´í„° ì¡°íšŒ (yearlyWholeStatus ì‚¬ìš©)
  const loadManagementTable = async (year: number) => {
    try {
      setTableLoading(true);
      
      // yearlyWholeStatusê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ API í˜¸ì¶œ ì‹œë„
      if (yearlyWholeStatus && yearlyWholeStatus.length > 0) {
        const tableData = yearlyWholeStatus
          .filter((item: any) => item.leaveType !== 'ì´ê³„')
          .map((item: any) => ({
            leaveType: item.leaveType || '',
            allowedDays: item.totalDays || 0,
            usedByMonth: [
              item.m01 || 0,
              item.m02 || 0,
              item.m03 || 0,
              item.m04 || 0,
              item.m05 || 0,
              item.m06 || 0,
              item.m07 || 0,
              item.m08 || 0,
              item.m09 || 0,
              item.m10 || 0,
              item.m11 || 0,
              item.m12 || 0,
            ],
            totalUsed: [
              item.m01 || 0,
              item.m02 || 0,
              item.m03 || 0,
              item.m04 || 0,
              item.m05 || 0,
              item.m06 || 0,
              item.m07 || 0,
              item.m08 || 0,
              item.m09 || 0,
              item.m10 || 0,
              item.m11 || 0,
              item.m12 || 0,
            ].reduce((sum: number, val: number) => sum + val, 0),
          }));
        setManagementTableData(tableData);
        return;
      }
      
      // yearlyWholeStatusê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ë°ì´í„° ì‚¬ìš©
      if (leaveData.yearlyWholeStatus && leaveData.yearlyWholeStatus.length > 0) {
        const tableData = leaveData.yearlyWholeStatus
          .filter((item: any) => item.leaveType !== 'ì´ê³„')
          .map((item: any) => ({
            leaveType: item.leaveType || '',
            allowedDays: item.totalDays || 0,
            usedByMonth: [
              item.m01 || 0,
              item.m02 || 0,
              item.m03 || 0,
              item.m04 || 0,
              item.m05 || 0,
              item.m06 || 0,
              item.m07 || 0,
              item.m08 || 0,
              item.m09 || 0,
              item.m10 || 0,
              item.m11 || 0,
              item.m12 || 0,
            ],
            totalUsed: [
              item.m01 || 0,
              item.m02 || 0,
              item.m03 || 0,
              item.m04 || 0,
              item.m05 || 0,
              item.m06 || 0,
              item.m07 || 0,
              item.m08 || 0,
              item.m09 || 0,
              item.m10 || 0,
              item.m11 || 0,
              item.m12 || 0,
            ].reduce((sum: number, val: number) => sum + val, 0),
          }));
        setManagementTableData(tableData);
      }
    } catch (err: any) {
      console.error('íœ´ê°€ ê´€ë¦¬ ëŒ€ì¥ ì¡°íšŒ ì‹¤íŒ¨:', err);
      setManagementTableData([]);
    } finally {
      setTableLoading(false);
    }
  };

  const handleRequestDialogOpen = () => {
    setRequestDialogOpen(true);
  };

  const handleRequestDialogClose = () => {
    setRequestDialogOpen(false);
    setIsSequentialApproval(false); // ìˆœì°¨ê²°ì¬ ëª¨ë“œ ì´ˆê¸°í™”
    setRequestForm({
      leaveType: '',
      startDate: dayjs(),
      endDate: dayjs(),
      reason: '',
      halfDaySlot: '',
      approverIds: [],
      ccList: [],
      useHalfDay: false,
      useNextYearLeave: false,
    });
  };

  // ì·¨ì†Œ ìƒì‹  ì²˜ë¦¬
  const handleCancelRequest = async () => {
    if (!cancelRequestLeave) return;

    try {
      const user = authService.getCurrentUser();
      if (!user) {
        alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const cancelRequest: LeaveCancelRequest = {
        id: cancelRequestLeave.id,
        userId: user.userId,
      };

      const response = await leaveService.cancelLeaveRequestNew(cancelRequest);

      if (response.error) {
        alert(`ì·¨ì†Œ ìƒì‹  ì‹¤íŒ¨: ${response.error}`);
        return;
      }

      // ì„±ê³µ ì‹œ ë°ì´í„° ê°±ì‹ 
      onRefresh();
      setCancelRequestModalOpen(false);
      setCancelRequestLeave(null);
      alert('ì·¨ì†Œ ìƒì‹ ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    } catch (error: any) {
      console.error('ì·¨ì†Œ ìƒì‹  ì‹¤íŒ¨:', error);
      alert(`ì·¨ì†Œ ìƒì‹  ì‹¤íŒ¨: ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}`);
    }
  };

  // Flutterì™€ ë™ì¼í•œ ë°˜ì°¨ íƒ€ì… ë³€í™˜ í•¨ìˆ˜
  const getHalfDaySlotValue = (): string => {
    if (requestForm.useHalfDay && requestForm.halfDaySlot === 'ì˜¤ì „') {
      return 'AM';
    } else if (requestForm.useHalfDay && requestForm.halfDaySlot === 'ì˜¤í›„') {
      return 'PM';
    }
    return 'ALL';
  };

  const handleRequestSubmit = async () => {
    try {
      const user = authService.getCurrentUser();
      if (!user) return;

      if (!requestForm.leaveType || !requestForm.reason.trim()) {
        alert('íœ´ê°€ ì¢…ë¥˜ì™€ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // Flutterì™€ ë™ì¼í•œ ë‚ ì§œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
      const formatDateForApi = (dayjsDate: any): string => {
        const date = dayjsDate.toDate();
        const utcDate = new Date(
          Date.UTC(
            date.getFullYear(),
            date.getMonth(),
            date.getDate(),
            date.getHours(),
            date.getMinutes(),
            date.getSeconds()
          )
        );
        return utcDate.toISOString().replace('.000Z', 'Z');
      };

      // ìˆœì°¨ê²°ì¬ ëª¨ë“œì¸ ê²½ìš° approvalLine ìƒì„±
      let approvalLine: LeaveRequestApprovalLine[] | undefined;
      let approverIds: string[] | undefined;

      if (isSequentialApproval && requestForm.approverIds.length > 0) {
        // ìˆœì°¨ê²°ì¬: approvalLine ìƒì„±
        approvalLine = requestForm.approverIds.map((approverId, index) => {
          const approver = approverList.find((a) => a.approverId === approverId);
          const nextApproverId = index < requestForm.approverIds.length - 1
            ? requestForm.approverIds[index + 1]
            : '';
          
          return {
            approverId: approverId,
            nextApproverId: nextApproverId,
            approvalSeq: index + 1, // 1ë¶€í„° ì‹œì‘
            approverName: approver?.approverName || approverId,
          };
        });
      } else {
        // ì¼ë°˜ ëª¨ë“œ: approverIds ì‚¬ìš©
        approverIds = requestForm.approverIds.length > 0 
          ? requestForm.approverIds 
          : [user.userId];
      }

      const request: LeaveRequestRequest = {
        userId: user.userId,
        leaveType: requestForm.leaveType,
        startDate: formatDateForApi(requestForm.startDate),
        endDate: formatDateForApi(requestForm.endDate),
        approverIds: approverIds,
        approvalLine: approvalLine,
        ccList: requestForm.ccList.map((cc) => ({
          name: cc.name,
          department: cc.department,
        })),
        reason: requestForm.reason.trim(),
        halfDaySlot: getHalfDaySlotValue(),
        isNextYear: requestForm.useNextYearLeave ? 1 : 0,
      };

      await leaveService.submitLeaveRequest(request);
      handleRequestDialogClose();
      onRefresh();
      alert('íœ´ê°€ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    } catch (err: any) {
      console.error('íœ´ê°€ ì‹ ì²­ ì‹¤íŒ¨:', err);
      const errorMessage = err.response?.data?.error 
        || err.response?.data?.message 
        || err.response?.data?.detail
        || err.message
        || 'íœ´ê°€ ì‹ ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
      alert(`íœ´ê°€ ì‹ ì²­ ì‹¤íŒ¨: ${errorMessage}`);
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'APPROVED':
        return '#20C997';
      case 'REJECTED':
        return '#DC3545';
      case 'REQUESTED':
        return '#FF8C00';
      case 'CANCEL_REQUESTED':
        return '#F59E0B';
      case 'CANCELLED':
        return '#9CA3AF';
      default:
        return '#6B7280';
    }
  };

  const getStatusIcon = (status: string) => {
    const colors = {
      approved: isDark ? '#34D399' : '#20C997',
      rejected: isDark ? '#F87171' : '#DC3545',
      requested: isDark ? '#FBBF24' : '#FF8C00',
      cancelRequested: isDark ? '#FCD34D' : '#F59E0B',
      cancelled: isDark ? '#9CA3AF' : '#9CA3AF',
      default: isDark ? '#9CA3AF' : '#6B7280',
    };

    switch (status) {
      case 'APPROVED':
        return <CheckCircleIcon sx={{ color: colors.approved, fontSize: 20 }} />;
      case 'REJECTED':
        return <CancelIcon sx={{ color: colors.rejected, fontSize: 20 }} />;
      case 'REQUESTED':
        return <PendingIcon sx={{ color: colors.requested, fontSize: 20 }} />;
      case 'CANCEL_REQUESTED':
        return <PendingIcon sx={{ color: colors.cancelRequested, fontSize: 20 }} />;
      case 'CANCELLED':
        return <CancelIcon sx={{ color: colors.cancelled, fontSize: 20 }} />;
      default:
        return <ScheduleIcon sx={{ color: colors.default, fontSize: 20 }} />;
    }
  };

  // ê°œì¸ë³„ íœ´ê°€ ë‚´ì—­ í˜ì´ì§€ë„¤ì´ì…˜ ë¡œì§
  const getFilteredYearlyDetails = () => {
    if (!yearlyDetails || !Array.isArray(yearlyDetails)) {
      console.log('âš ï¸ yearlyDetailsê°€ ë°°ì—´ì´ ì•„ë‹˜:', yearlyDetails);
      return [];
    }
    const filtered = yearlyDetails.filter((detail: any) => !hideCanceled || detail.status !== 'CANCELLED');
    console.log('ğŸ” ê°œì¸ë³„ íœ´ê°€ ë‚´ì—­ - ì „ì²´:', yearlyDetails.length, 'í•„í„°ë§ í›„:', filtered.length);
    return filtered;
  };

  const getPaginatedYearlyDetails = () => {
    const filtered = getFilteredYearlyDetails();
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const paginated = filtered.slice(startIndex, endIndex);
    console.log('ğŸ“„ í˜ì´ì§€ë„¤ì´ì…˜ - í˜„ì¬í˜ì´ì§€:', currentPage, 'ì‹œì‘:', startIndex, 'ë:', endIndex, 'ê²°ê³¼:', paginated.length);
    return paginated;
  };

  const filteredCount = getFilteredYearlyDetails().length;
  const totalPages = Math.max(1, Math.ceil(filteredCount / itemsPerPage));
  console.log('ğŸ“Š ì´ í˜ì´ì§€:', totalPages, 'í˜„ì¬ í˜ì´ì§€:', currentPage, 'ì „ì²´ í•­ëª©:', filteredCount);

  const handlePageChange = (page: number) => {
    setCurrentPage(page);
  };

  // í•„í„° ë³€ê²½ ì‹œ í˜ì´ì§€ 1ë¡œ ë¦¬ì…‹
  useEffect(() => {
    console.log('ğŸ”„ í˜ì´ì§€ ë¦¬ì…‹ - ì—°ë„:', selectedYear, 'ì·¨ì†Œê±´ìˆ¨ê¹€:', hideCanceled);
    setCurrentPage(1);
  }, [selectedYear, hideCanceled, yearlyDetails]);

  return (
    <Box sx={{ height: '100vh', display: 'flex', flexDirection: 'column', bgcolor: colorScheme.backgroundColor }}>
      {/* ì‚¬ì´ë“œë°”ì™€ ë©”ì¸ ì»¨í…ì¸ ë¥¼ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ */}
      <Box sx={{ display: 'flex', flex: 1, overflow: 'hidden' }}>
        {/* ì‚¬ì´ë“œë°” */}
        <Box
          sx={{
            width: sidebarOpen ? 240 : 60,
            bgcolor: colorScheme.surfaceColor,
            borderRight: `1px solid ${colorScheme.textFieldBorderColor}`,
            display: 'flex',
            flexDirection: 'column',
            transition: 'width 0.3s ease-in-out',
            position: 'relative',
            zIndex: 1000,
          }}
        >
          {/* ì‚¬ì´ë“œë°” í—¤ë” */}
          <Box
            sx={{
              p: 1.5,
              display: 'flex',
              alignItems: 'center',
              justifyContent: sidebarOpen ? 'space-between' : 'center',
              borderBottom: `1px solid ${colorScheme.textFieldBorderColor}`,
              minHeight: 64,
            }}
          >
            {sidebarOpen && (
              <Typography sx={{ fontSize: '16px', fontWeight: 600, color: colorScheme.textColor }}>
                ë©”ë‰´
              </Typography>
            )}
            <IconButton
              onClick={() => setSidebarOpen(!sidebarOpen)}
              sx={{
                color: colorScheme.hintTextColor,
                '&:hover': { bgcolor: isDark ? 'rgba(255, 255, 255, 0.05)' : '#F3F4F6' },
              }}
            >
              {sidebarOpen ? <ChevronLeftIcon /> : <MenuIcon />}
            </IconButton>
          </Box>

          {/* ì‚¬ì´ë“œë°” ë©”ë‰´ */}
          <Box sx={{ flex: 1, overflow: 'auto', py: 1 }}>
            <Box
              onClick={() => {
                setTotalCalendarOpen(true);
              }}
              sx={{
                display: 'flex',
                alignItems: 'center',
                px: sidebarOpen ? 2 : 1.5,
                py: 1.5,
                cursor: 'pointer',
                '&:hover': {
                  bgcolor: isDark ? 'rgba(255, 255, 255, 0.05)' : '#F3F4F6',
                },
              }}
            >
              <CalendarMonthIcon sx={{ color: colorScheme.primaryColor, fontSize: 24 }} />
              {sidebarOpen && (
                <Typography
                  sx={{
                    ml: 2,
                    fontSize: '14px',
                    fontWeight: 500,
                    color: colorScheme.textColor,
                  }}
                >
                  íœ´ê°€ì¼ì •ë‹¬ë ¥
                </Typography>
              )}
            </Box>
          </Box>
        </Box>

        {/* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */}
        <Box sx={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
      {/* AppBar - Flutter ìŠ¤íƒ€ì¼ */}
      <Box
        sx={{
          bgcolor: colorScheme.surfaceColor,
          borderBottom: `1px solid ${colorScheme.textFieldBorderColor}`,
          px: 2,
          py: 1.5,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
        }}
      >
        {/* ì™¼ìª½: ë’¤ë¡œê°€ê¸° ë²„íŠ¼ + íƒ€ì´í‹€ */}
        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
          <IconButton
            onClick={() => navigate('/chat')}
            sx={{
              color: colorScheme.textColor,
              '&:hover': {
                bgcolor: isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.04)',
              },
            }}
          >
            <ArrowBackIcon />
          </IconButton>
          <Typography variant="h6" sx={{ fontWeight: 600, fontSize: '18px', color: colorScheme.textColor }}>
            íœ´ê°€ê´€ë¦¬
          </Typography>
        </Box>

        {/* Toolbar Buttons - Flutter ìŠ¤íƒ€ì¼ */}
        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
          {/* ê´€ë¦¬ììš© ê²°ì¬ ë²„íŠ¼ - ë””ë²„ê¹…ìš© (í•­ìƒ í‘œì‹œ) */}
            <Button
              variant="contained"
              startIcon={<AdminPanelSettingsIcon sx={{ fontSize: 18 }} />}
            onClick={() => {
              console.log('ê´€ë¦¬ì ê¶Œí•œ:', authService.hasAdminPermission());
              console.log('ì‚¬ìš©ì ì •ë³´:', authService.getCurrentUser());
              navigate('/admin-leave', { replace: false });
            }}
              sx={{
                bgcolor: isDark ? '#8B5CF6' : '#6F42C1',
                color: 'white',
                fontSize: '13px',
                fontWeight: 600,
                textTransform: 'none',
                borderRadius: '8px',
                px: 2,
                py: 0.75,
                '&:hover': {
                  bgcolor: isDark ? '#7C3AED' : '#5a359a',
                },
              }}
            >
              ê´€ë¦¬ììš© ê²°ì¬
            </Button>

          {/* ì·¨ì†Œê±´ ìˆ¨ê¹€ ë²„íŠ¼ */}
          <Button
            variant="text"
            startIcon={
              hideCanceled ? (
                <VisibilityIcon sx={{ fontSize: 18 }} />
              ) : (
                <VisibilityOffIcon sx={{ fontSize: 18 }} />
              )
            }
            onClick={() => setHideCanceled(!hideCanceled)}
            sx={{
              color: colorScheme.textColor,
              fontSize: '13px',
              textTransform: 'none',
            }}
          >
            ì·¨ì†Œê±´ ìˆ¨ê¹€
          </Button>

          {/* íœ´ê°€ ì‘ì„± ë²„íŠ¼ */}
          <Button
            variant="contained"
            startIcon={<EditCalendarIcon sx={{ fontSize: 18 }} />}
            onClick={handleRequestDialogOpen}
            sx={{
              bgcolor: isDark ? '#60A5FA' : '#3B82F6',
              color: 'white',
              fontSize: '13px',
              fontWeight: 600,
              textTransform: 'none',
              borderRadius: '8px',
              px: 2,
              py: 0.75,
              '&:hover': {
                bgcolor: isDark ? '#3B82F6' : '#2563EB',
              },
            }}
          >
            íœ´ê°€ ì‘ì„±
          </Button>
        </Box>
      </Box>

      {/* Main Content - Flutter ë ˆì´ì•„ì›ƒê³¼ ë™ì¼ */}
      <Box sx={{ flex: 1, overflow: 'auto', p: 2 }}>
        <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1.5, height: '100%' }}>
          {/* ìƒë‹¨ ì˜ì—­: ë‚´ íœ´ê°€ í˜„í™© + ê²°ì¬ì§„í–‰ í˜„í™© */}
          <Box sx={{ display: 'flex', gap: 1.5, flexShrink: 0, alignItems: 'stretch' }}>
            {/* ì™¼ìª½: ë‚´ íœ´ê°€ í˜„í™© */}
            <Box sx={{ flex: 1, display: 'flex' }}>
              <Card
                sx={{
                  width: '100%',
                  borderRadius: '12px',
                  border: `1px solid ${colorScheme.textFieldBorderColor}`,
                  boxShadow: isDark ? '0 2px 8px rgba(0, 0, 0, 0.2)' : '0 2px 8px rgba(0, 0, 0, 0.04)',
                  display: 'flex',
                  flexDirection: 'column',
                  bgcolor: colorScheme.surfaceColor,
                }}
              >
                <CardContent sx={{ p: 1.5, '&:last-child': { pb: 1.5 }, display: 'flex', flexDirection: 'column', flex: 1 }}>
                  <Box sx={{ display: 'flex', alignItems: 'center', mb: 1, flexShrink: 0 }}>
                    <Box
                      sx={{
                        p: 0.75,
                        borderRadius: '8px',
                        background: isDark
                          ? 'linear-gradient(135deg, #34D399 0%, #10B981 100%)'
                          : 'linear-gradient(135deg, #20C997 0%, #17A589 100%)',
                        mr: 1,
                      }}
                    >
                      <EventIcon sx={{ color: 'white', fontSize: 14 }} />
                    </Box>
                    <Typography sx={{ fontSize: '13px', fontWeight: 700, color: colorScheme.textColor }}>
                      ë‚´ íœ´ê°€ í˜„í™©
                    </Typography>
                  </Box>

                  <Box sx={{ display: 'flex', gap: 1, flex: 1, alignItems: 'stretch' }}>
                    {leaveData.leaveStatus && leaveData.leaveStatus.length > 0 ? (
                      leaveData.leaveStatus.slice(0, 4).map((status: any, index: number) => (
                        <Box
                          key={index}
                          sx={{
                            flex: 1,
                            textAlign: 'center',
                            p: 1,
                            borderRadius: '6px',
                            bgcolor: isDark ? 'rgba(52, 211, 153, 0.15)' : 'rgba(32, 201, 151, 0.08)',
                            display: 'flex',
                            flexDirection: 'column',
                            justifyContent: 'center',
                          }}
                        >
                          <Typography sx={{ fontSize: '10px', color: colorScheme.hintTextColor, mb: 0.25, fontWeight: 500 }}>
                            {status.leave_type || status.leaveType}
                          </Typography>
                          <Typography
                            sx={{
                              fontSize: '16px',
                              fontWeight: 700,
                              color: isDark ? '#34D399' : '#20C997',
                              lineHeight: 1.1,
                            }}
                          >
                            {status.remain_days || status.remainDays || 0}
                            <Typography component="span" sx={{ fontSize: '10px', ml: 0.25 }}>
                              ì¼
                            </Typography>
                          </Typography>
                          <Typography sx={{ fontSize: '9px', color: colorScheme.hintTextColor, mt: 0.25 }}>
                            / {status.total_days || status.totalDays || 0}ì¼
                          </Typography>
                        </Box>
                      ))
                    ) : (
                      <Typography sx={{ fontSize: '12px', color: colorScheme.hintTextColor, textAlign: 'center', flex: 1, py: 1.5 }}>
                        íœ´ê°€ ì •ë³´ ì—†ìŒ
                      </Typography>
                    )}
                  </Box>
                </CardContent>
              </Card>
            </Box>

            {/* ì˜¤ë¥¸ìª½: ê²°ì¬ì§„í–‰ í˜„í™© */}
            <Box sx={{ flex: 1, display: 'flex' }}>
              <Card
                sx={{
                  width: '100%',
                  borderRadius: '12px',
                  border: `1px solid ${colorScheme.textFieldBorderColor}`,
                  boxShadow: isDark ? '0 2px 8px rgba(0, 0, 0, 0.2)' : '0 2px 8px rgba(0, 0, 0, 0.04)',
                  display: 'flex',
                  flexDirection: 'column',
                  bgcolor: colorScheme.surfaceColor,
                }}
              >
                <CardContent sx={{ p: 1.5, '&:last-child': { pb: 1.5 }, display: 'flex', flexDirection: 'column', flex: 1 }}>
                  <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', mb: 1, flexShrink: 0 }}>
                    <Box sx={{ display: 'flex', alignItems: 'center' }}>
                      <Box
                        sx={{
                          p: 0.75,
                          borderRadius: '8px',
                          background: isDark
                            ? 'linear-gradient(135deg, #60A5FA 0%, #3B82F6 100%)'
                            : 'linear-gradient(135deg, #1E88E5 0%, #1976D2 100%)',
                          mr: 1,
                        }}
                      >
                        <AssignmentIcon sx={{ color: 'white', fontSize: 14 }} />
                      </Box>
                      <Typography sx={{ fontSize: '13px', fontWeight: 700, color: colorScheme.textColor }}>
                        ê²°ì¬ ì§„í–‰ í˜„í™©
                      </Typography>
                    </Box>

                    <Chip
                      label={`ì´ ${
                        (leaveData.approvalStatus?.requested || 0) +
                        (leaveData.approvalStatus?.approved || 0) +
                        (leaveData.approvalStatus?.rejected || 0)
                      }ê±´`}
                      size="small"
                      sx={{
                        bgcolor: isDark ? 'rgba(96, 165, 250, 0.2)' : 'rgba(30, 136, 229, 0.12)',
                        color: isDark ? '#60A5FA' : '#1E88E5',
                        fontSize: '10px',
                        fontWeight: 600,
                        height: 22,
                        px: 0.75,
                      }}
                    />
                  </Box>

                  <Box sx={{ display: 'flex', gap: 1, flex: 1, alignItems: 'stretch' }}>
                    {/* ëŒ€ê¸°ì¤‘ */}
                    <Box sx={{ flex: 1, textAlign: 'center', p: 1, borderRadius: '6px', bgcolor: isDark ? 'rgba(251, 191, 36, 0.15)' : 'rgba(255, 140, 0, 0.08)', display: 'flex', flexDirection: 'column', justifyContent: 'center' }}>
                      <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 0.25, mb: 0.25 }}>
                        <ScheduleIcon sx={{ fontSize: 12, color: isDark ? '#FBBF24' : '#FF8C00' }} />
                        <Typography sx={{ fontSize: '10px', color: colorScheme.hintTextColor, fontWeight: 500 }}>ëŒ€ê¸°ì¤‘</Typography>
                      </Box>
                      <Typography sx={{ fontSize: '18px', fontWeight: 700, color: isDark ? '#FBBF24' : '#FF8C00', lineHeight: 1.1 }}>
                        {leaveData.approvalStatus?.requested || 0}
                      </Typography>
                    </Box>

                    {/* ìŠ¹ì¸ë¨ */}
                    <Box sx={{ flex: 1, textAlign: 'center', p: 1, borderRadius: '6px', bgcolor: isDark ? 'rgba(52, 211, 153, 0.15)' : 'rgba(32, 201, 151, 0.08)', display: 'flex', flexDirection: 'column', justifyContent: 'center' }}>
                      <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 0.25, mb: 0.25 }}>
                        <CheckCircleIcon sx={{ fontSize: 12, color: isDark ? '#34D399' : '#20C997' }} />
                        <Typography sx={{ fontSize: '10px', color: colorScheme.hintTextColor, fontWeight: 500 }}>ìŠ¹ì¸ë¨</Typography>
                      </Box>
                      <Typography sx={{ fontSize: '18px', fontWeight: 700, color: isDark ? '#34D399' : '#20C997', lineHeight: 1.1 }}>
                        {leaveData.approvalStatus?.approved || 0}
                      </Typography>
                    </Box>

                    {/* ë°˜ë ¤ë¨ */}
                    <Box sx={{ flex: 1, textAlign: 'center', p: 1, borderRadius: '6px', bgcolor: isDark ? 'rgba(248, 113, 113, 0.15)' : 'rgba(220, 53, 69, 0.08)', display: 'flex', flexDirection: 'column', justifyContent: 'center' }}>
                      <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 0.25, mb: 0.25 }}>
                        <CancelIcon sx={{ fontSize: 12, color: isDark ? '#F87171' : '#DC3545' }} />
                        <Typography sx={{ fontSize: '10px', color: colorScheme.hintTextColor, fontWeight: 500 }}>ë°˜ë ¤ë¨</Typography>
                      </Box>
                      <Typography sx={{ fontSize: '18px', fontWeight: 700, color: isDark ? '#F87171' : '#DC3545', lineHeight: 1.1 }}>
                        {leaveData.approvalStatus?.rejected || 0}
                      </Typography>
                    </Box>
                  </Box>
                </CardContent>
              </Card>
            </Box>
          </Box>

          {/* í•˜ë‹¨ ì˜ì—­: ê°œì¸ë³„ íœ´ê°€ ë‚´ì—­ + ë‹¬ë ¥/íœ´ê°€ ê´€ë¦¬ ëŒ€ì¥ */}
          <Box sx={{ display: 'flex', gap: 1.5, flex: 1, minHeight: 0 }}>
            {/* ì™¼ìª½: ê°œì¸ë³„ íœ´ê°€ ë‚´ì—­ (50%) */}
            <Box sx={{ flex: 1, minHeight: 0, display: 'flex', flexDirection: 'column' }}>
              <Card sx={{ height: '100%', borderRadius: '16px', display: 'flex', flexDirection: 'column', bgcolor: colorScheme.surfaceColor, border: `1px solid ${colorScheme.textFieldBorderColor}` }}>
                <CardContent sx={{ p: 2, flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden', minHeight: 0 }}>
                  <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', mb: 2, flexShrink: 0 }}>
                    <Typography sx={{ fontSize: '16px', fontWeight: 700, color: colorScheme.textColor }}>ê°œì¸ë³„ íœ´ê°€ ë‚´ì—­</Typography>
                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                      <Chip
                        label={`${filteredCount}ê±´${filteredCount > 0 ? ` (${currentPage}/${totalPages}í˜ì´ì§€)` : ''}`}
                        size="small"
                        color={filteredCount > itemsPerPage ? "primary" : "default"}
                        sx={{ fontSize: '11px' }}
                      />
                      <FormControl size="small" sx={{ minWidth: 100 }}>
                        <Select
                          value={selectedYear}
                          onChange={(e) => setSelectedYear(e.target.value as number)}
                          sx={{ fontSize: '13px' }}
                        >
                          {[2024, 2025, 2026].map((year) => (
                            <MenuItem key={year} value={year}>
                              {year}ë…„
                            </MenuItem>
                          ))}
                        </Select>
                      </FormControl>
                    </Box>
                  </Box>

                  <Box sx={{ flex: 1, overflow: 'auto' }}>
                    {yearlyLoading ? (
                      <Box sx={{ display: 'flex', justifyContent: 'center', py: 4 }}>
                        <CircularProgress size={24} />
                      </Box>
                    ) : getPaginatedYearlyDetails().length > 0 ? (
                      <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1 }}>
                        {getPaginatedYearlyDetails().map((detail: any, index: number) => (
                          <Box
                            key={index}
                            sx={{
                              p: 1.5,
                              border: '1px solid',
                              borderColor: colorScheme.textFieldBorderColor,
                              borderRadius: '8px',
                              cursor: detail.status === 'APPROVED' ? 'pointer' : 'default',
                              bgcolor: colorScheme.surfaceColor,
                              '&:hover': {
                                bgcolor: detail.status === 'APPROVED'
                                  ? (isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.02)')
                                  : 'transparent',
                              },
                            }}
                            onClick={() => {
                              if (detail.status === 'APPROVED') {
                                setSelectedLeaveDetail(detail);
                                setDetailPanelOpen(true);
                              }
                            }}
                          >
                            <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', mb: 0.5 }}>
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                {getStatusIcon(detail.status)}
                                <Typography sx={{ fontSize: '14px', fontWeight: 600, color: colorScheme.textColor }}>
                                  {detail.leaveType}
                                </Typography>
                              </Box>
                              <Chip
                                label={
                                  detail.status === 'APPROVED' ? 'ìŠ¹ì¸' :
                                  detail.status === 'REJECTED' ? 'ë°˜ë ¤' :
                                  detail.status === 'REQUESTED' ? 'ëŒ€ê¸°' :
                                  detail.status === 'CANCEL_REQUESTED' ? 'ì·¨ì†Œ ëŒ€ê¸°' :
                                  detail.status === 'CANCELLED' ? 'ì·¨ì†Œ' :
                                  'ëŒ€ê¸°'
                                }
                                size="small"
                                sx={{
                                  bgcolor: `${getStatusColor(detail.status)}22`,
                                  color: getStatusColor(detail.status),
                                  fontSize: '11px',
                                  height: 20,
                                }}
                              />
                            </Box>
                            <Typography sx={{ fontSize: '12px', color: colorScheme.hintTextColor }}>
                              {dayjs(detail.startDate).format('YYYY-MM-DD')} ~ {dayjs(detail.endDate).format('YYYY-MM-DD')}
                            </Typography>
                            <Typography sx={{ fontSize: '12px', color: colorScheme.hintTextColor, mt: 0.5 }}>
                              {detail.reason}
                            </Typography>
                          </Box>
                        ))}
                      </Box>
                    ) : (
                      <Box sx={{ textAlign: 'center', py: 4 }}>
                        <EventIcon sx={{ fontSize: 60, color: isDark ? '#4B5563' : '#E5E7EB', mb: 1 }} />
                        <Typography sx={{ color: colorScheme.hintTextColor }}>
                          {getFilteredYearlyDetails().length === 0 ? 'íœ´ê°€ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤' : 'í•´ë‹¹ í˜ì´ì§€ì— í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤'}
                        </Typography>
                      </Box>
                    )}
                  </Box>

                  {/* í˜ì´ì§€ë„¤ì´ì…˜ */}
                  {totalPages > 1 && (
                    <Box sx={{ display: 'flex', justifyContent: 'center', mt: 2, flexShrink: 0 }}>
                      <Stack spacing={2}>
                        <Pagination
                          count={totalPages}
                          page={currentPage}
                          onChange={(e, page) => handlePageChange(page)}
                          color="primary"
                          size="small"
                          showFirstButton
                          showLastButton
                        />
                      </Stack>
                    </Box>
                  )}
                </CardContent>
              </Card>
            </Box>

            {/* ì˜¤ë¥¸ìª½: ë‹¬ë ¥ + íœ´ê°€ ê´€ë¦¬ ëŒ€ì¥ (50%) */}
            <Box sx={{ flex: 1, display: 'flex', flexDirection: 'column', gap: 1.5, minHeight: 0 }}>
              {/* ìœ„: íœ´ê°€ ì¼ì • ë‹¬ë ¥ (55%) */}
              <Box sx={{ flex: 5.5, minHeight: 0, display: 'flex', flexDirection: 'column' }}>
                <Card sx={{ height: '100%', borderRadius: '16px', display: 'flex', flexDirection: 'column', bgcolor: colorScheme.surfaceColor, border: `1px solid ${colorScheme.textFieldBorderColor}` }}>
                  <CardContent sx={{ p: 1, flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden', minHeight: 0, '&:last-child': { pb: 1 } }}>
                    <Typography sx={{ fontSize: '14px', fontWeight: 700, mb: 0.75, flexShrink: 0, color: colorScheme.textColor }}>íœ´ê°€ ì¼ì • ë‹¬ë ¥</Typography>
                    <Box sx={{ flex: 1, overflow: 'hidden', minHeight: 0, display: 'flex', flexDirection: 'column' }}>
                      <PersonalCalendar
                        monthlyLeaves={leaveData.monthlyLeaves || []}
                        loading={false}
                        error={null}
                        onTotalCalendarOpen={() => setTotalCalendarOpen(true)}
                      />
                    </Box>
                  </CardContent>
                </Card>
              </Box>

              {/* ì•„ë˜: íœ´ê°€ ê´€ë¦¬ ëŒ€ì¥ (45%) */}
              <Box sx={{ flex: 4.5, minHeight: 0, display: 'flex', flexDirection: 'column' }}>
                <Card sx={{ height: '100%', borderRadius: '16px', display: 'flex', flexDirection: 'column', bgcolor: colorScheme.surfaceColor, border: `1px solid ${colorScheme.textFieldBorderColor}` }}>
                  <CardContent sx={{ p: 2, flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden', minHeight: 0 }}>
                    <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', mb: 2, flexShrink: 0 }}>
                      <Typography sx={{ fontSize: '16px', fontWeight: 700, color: colorScheme.textColor }}>íœ´ê°€ ê´€ë¦¬ ëŒ€ì¥</Typography>
                      <IconButton
                        onClick={() => setManagementTableDialogOpen(true)}
                        size="small"
                        sx={{ p: 0.5 }}
                        title="í¬ê²Œ ë³´ê¸°"
                      >
                        <FullscreenIcon />
                      </IconButton>
                    </Box>
                    <Box sx={{ flex: 1, overflow: 'auto' }}>
                      <TableContainer sx={{ maxHeight: '100%', overflowX: 'auto' }}>
                        <Table size="small" stickyHeader sx={{ borderCollapse: 'separate', minWidth: 800 }}>
                          <TableHead>
                            <TableRow>
                              <TableCell
                                sx={{
                                  fontSize: '11px',
                                  fontWeight: 600,
                                  bgcolor: isDark ? 'rgba(255, 255, 255, 0.05)' : '#F9FAFB',
                                  color: colorScheme.textColor,
                                  px: 1,
                                  py: 1,
                                  borderRight: `1px solid ${colorScheme.textFieldBorderColor}`,
                                  position: 'sticky',
                                  left: 0,
                                  zIndex: 3,
                                }}
                              >
                                íœ´ê°€ì¢…ë¥˜
                              </TableCell>
                              <TableCell
                                sx={{
                                  fontSize: '11px',
                                  fontWeight: 600,
                                  bgcolor: isDark ? 'rgba(255, 255, 255, 0.05)' : '#F9FAFB',
                                  color: colorScheme.textColor,
                                  px: 1,
                                  py: 1,
                                  borderRight: `1px solid ${colorScheme.textFieldBorderColor}`,
                                  textAlign: 'center',
                                }}
                              >
                                í—ˆìš©ì¼ìˆ˜
                              </TableCell>
                              {/* ì›”ë³„ ì‚¬ìš© í˜„í™© í—¤ë” */}
                              <TableCell
                                colSpan={12}
                                sx={{
                                  fontSize: '11px',
                                  fontWeight: 600,
                                  bgcolor: isDark ? 'rgba(255, 255, 255, 0.05)' : '#F9FAFB',
                                  color: colorScheme.textColor,
                                  px: 0,
                                  py: 1,
                                  borderRight: `1px solid ${colorScheme.textFieldBorderColor}`,
                                  textAlign: 'center',
                                }}
                              >
                                <Box sx={{ display: 'flex', flexDirection: 'column', gap: 0.5 }}>
                                  <Typography sx={{ fontSize: '11px', fontWeight: 600, color: colorScheme.textColor }}>
                                    ì›”ë³„ ì‚¬ìš© í˜„í™©
                                  </Typography>
                                  <Box sx={{ display: 'flex' }}>
                                    {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12].map((month) => (
                                      <Box
                                        key={month}
                                        sx={{
                                          flex: 1,
                                          fontSize: '10px',
                                          fontWeight: 500,
                                          color: colorScheme.hintTextColor,
                                          borderRight: month < 12 ? `1px solid ${colorScheme.textFieldBorderColor}` : 'none',
                                          py: 0.5,
                                        }}
                                      >
                                        {month}ì›”
                                      </Box>
                                    ))}
                                  </Box>
                                </Box>
                              </TableCell>
                              <TableCell
                                sx={{
                                  fontSize: '11px',
                                  fontWeight: 600,
                                  bgcolor: isDark ? 'rgba(255, 255, 255, 0.05)' : '#F9FAFB',
                                  color: colorScheme.textColor,
                                  px: 1,
                                  py: 1,
                                  textAlign: 'center',
                                }}
                              >
                                ì‚¬ìš©ì¼ìˆ˜
                              </TableCell>
                              <TableCell
                                sx={{
                                  fontSize: '11px',
                                  fontWeight: 600,
                                  bgcolor: isDark ? 'rgba(255, 255, 255, 0.05)' : '#F9FAFB',
                                  color: colorScheme.textColor,
                                  px: 1,
                                  py: 1,
                                  textAlign: 'center',
                                }}
                              >
                                ë‚¨ì€ì¼ìˆ˜
                              </TableCell>
                            </TableRow>
                          </TableHead>
                          <TableBody>
                            {tableLoading ? (
                              <TableRow>
                                <TableCell colSpan={16} align="center" sx={{ py: 4 }}>
                                  <CircularProgress size={24} />
                                </TableCell>
                              </TableRow>
                            ) : managementTableData && managementTableData.length > 0 ? (
                              managementTableData.map((row: any, index: number) => {
                                const allowedDays = row.allowedDays || 0;
                                const totalUsed = row.totalUsed || 0;
                                const remainDays = allowedDays - totalUsed;
                                const usedByMonth = row.usedByMonth || Array(12).fill(0);
                                
                                return (
                                  <TableRow
                                    key={index}
                                    hover
                                    sx={{
                                      '&:hover': {
                                        bgcolor: isDark ? 'rgba(255, 255, 255, 0.05)' : '#F3F4F6',
                                        '& .sticky-cell': {
                                          bgcolor: isDark ? 'rgba(255, 255, 255, 0.05)' : '#F3F4F6',
                                        },
                                      },
                                    }}
                                  >
                                    <TableCell
                                      className="sticky-cell"
                                      sx={{
                                        fontSize: '11px',
                                        fontWeight: 600,
                                        px: 1,
                                        py: 1,
                                        borderRight: `1px solid ${colorScheme.textFieldBorderColor}`,
                                        position: 'sticky',
                                        left: 0,
                                        zIndex: 2,
                                        bgcolor: colorScheme.surfaceColor,
                                        color: colorScheme.textColor,
                                      }}
                                    >
                                      {row.leaveType || '-'}
                                    </TableCell>
                                    <TableCell
                                      sx={{
                                        fontSize: '11px',
                                        fontWeight: 600,
                                        px: 1,
                                        py: 1,
                                        borderRight: `1px solid ${colorScheme.textFieldBorderColor}`,
                                        textAlign: 'center',
                                        color: colorScheme.textColor,
                                      }}
                                    >
                                      {allowedDays > 0 ? allowedDays : '-'}
                                    </TableCell>
                                    {/* ì›”ë³„ ì‚¬ìš©ì¼ìˆ˜ */}
                                    {usedByMonth.map((days: number, monthIndex: number) => (
                                      <TableCell
                                        key={monthIndex}
                                        sx={{
                                          fontSize: '10px',
                                          fontWeight: 600,
                                          px: 0.5,
                                          py: 1,
                                          textAlign: 'center',
                                          borderRight: monthIndex < 11 ? `1px solid ${colorScheme.textFieldBorderColor}` : 'none',
                                          color: days > 0 ? colorScheme.textColor : colorScheme.hintTextColor,
                                        }}
                                      >
                                        {days > 0 ? days : '-'}
                                      </TableCell>
                                    ))}
                                    <TableCell
                                      sx={{
                                        fontSize: '11px',
                                        fontWeight: 600,
                                        px: 1,
                                        py: 1,
                                        borderRight: `1px solid ${colorScheme.textFieldBorderColor}`,
                                        textAlign: 'center',
                                        color: colorScheme.textColor,
                                      }}
                                    >
                                      {totalUsed > 0 ? totalUsed : '-'}
                                    </TableCell>
                                    <TableCell
                                      sx={{
                                        fontSize: '11px',
                                        fontWeight: 600,
                                        px: 1,
                                        py: 1,
                                        textAlign: 'center',
                                        color: remainDays > 0
                                          ? (isDark ? '#34D399' : '#059669')
                                          : (isDark ? '#F87171' : '#DC2626'),
                                      }}
                                    >
                                      {remainDays}
                                    </TableCell>
                                  </TableRow>
                                );
                              })
                            ) : (
                              <TableRow>
                                <TableCell colSpan={16} align="center" sx={{ py: 4 }}>
                                  <Typography sx={{ fontSize: '12px', color: colorScheme.hintTextColor }}>
                                    ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
                                  </Typography>
                                </TableCell>
                              </TableRow>
                            )}
                          </TableBody>
                        </Table>
                      </TableContainer>
                    </Box>
                  </CardContent>
                </Card>
              </Box>
            </Box>
          </Box>
        </Box>
      </Box>

      {/* íœ´ê°€ ì‹ ì²­ ë‹¤ì´ì–¼ë¡œê·¸ - Flutterì™€ ë™ì¼ */}
      <Dialog
        open={requestDialogOpen}
        onClose={handleRequestDialogClose}
        maxWidth="sm"
        fullWidth
        PaperProps={{
          sx: {
            bgcolor: colorScheme.surfaceColor,
          },
        }}
      >
        <DialogTitle sx={{ display: 'flex', alignItems: 'center', gap: 1, borderBottom: `1px solid ${colorScheme.textFieldBorderColor}` }}>
          <EditCalendarIcon sx={{ color: colorScheme.primaryColor }} />
          <Typography component="span" sx={{ fontWeight: 600, fontSize: '1.25rem', color: colorScheme.textColor }}>
            íœ´ê°€ ì‹ ì²­
          </Typography>
        </DialogTitle>

        <DialogContent sx={{ pt: 2 }}>
          <LocalizationProvider dateAdapter={AdapterDayjs}>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 3 }}>
              {/* ë‚´ë…„ ì •ê¸°íœ´ê°€ ì‚¬ìš©í•˜ê¸° ì²´í¬ë°•ìŠ¤ */}
              <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'flex-end' }}>
                <FormControlLabel
                  control={
                    <Checkbox
                      checked={requestForm.useNextYearLeave}
                      onChange={(e) =>
                        setRequestForm((prev) => ({ ...prev, useNextYearLeave: e.target.checked }))
                      }
                      color="primary"
                    />
                  }
                  label="ë‚´ë…„ ì •ê¸°íœ´ê°€ ì‚¬ìš©í•˜ê¸°"
                />
              </Box>

              {/* íœ´ê°€ ì¢…ë¥˜ */}
              <FormControl fullWidth>
                <InputLabel>íœ´ê°€ ì¢…ë¥˜</InputLabel>
                <Select
                  value={requestForm.leaveType}
                  onChange={(e) => setRequestForm((prev) => ({ ...prev, leaveType: e.target.value }))}
                  label="íœ´ê°€ ì¢…ë¥˜"
                  required
                >
                  <MenuItem value="ì—°ì°¨">ì—°ì°¨</MenuItem>
                  <MenuItem value="1ë…„ ë¯¸ë§Œ ì—°ì°¨">1ë…„ ë¯¸ë§Œ ì—°ì°¨</MenuItem>
                  <MenuItem value="ê¸°íƒ€ íœ´ê°€">ê¸°íƒ€ íœ´ê°€</MenuItem>
                  <MenuItem value="ë°±ì‹  ì ‘ì¢…(ì¤‘êµ­)">ë°±ì‹  ì ‘ì¢…(ì¤‘êµ­)</MenuItem>
                  <MenuItem value="ë°±ì‹  ì ‘ì¢…">ë°±ì‹  ì ‘ì¢…</MenuItem>
                  <MenuItem value="ë³‘ê°€">ë³‘ê°€</MenuItem>
                  <MenuItem value="ë³„ë„ ì—°ì°¨">ë³„ë„ ì—°ì°¨</MenuItem>
                  <MenuItem value="ë°°ìš°ì ì¶œì‚°íœ´ê°€">ë°°ìš°ì ì¶œì‚°íœ´ê°€</MenuItem>
                  <MenuItem value="ë¹„ë¡€ì—°ì°¨">ë¹„ë¡€ì—°ì°¨</MenuItem>
                  <MenuItem value="ëŒ€ì²´íœ´ê°€">ëŒ€ì²´íœ´ê°€</MenuItem>
                  <MenuItem value="ì—°ì°¨(ì¤‘êµ­)">ì—°ì°¨(ì¤‘êµ­)</MenuItem>
                  <MenuItem value="ì˜ˆë¹„êµ°/ë¯¼ë°©ìœ„ ì—°ì°¨">ì˜ˆë¹„êµ°/ë¯¼ë°©ìœ„ ì—°ì°¨</MenuItem>
                  <MenuItem value="ê²½ì¡°ì‚¬íœ´ê°€">ê²½ì¡°ì‚¬íœ´ê°€</MenuItem>
                  <MenuItem value="ì‚°ì „í›„íœ´ê°€">ì‚°ì „í›„íœ´ê°€</MenuItem>
                  <MenuItem value="ê²°í˜¼íœ´ê°€">ê²°í˜¼íœ´ê°€</MenuItem>
                  <MenuItem value="ì—°ì°¨(ë³„ë„ë¶€ì—¬)">ì—°ì°¨(ë³„ë„ë¶€ì—¬)</MenuItem>
                </Select>
              </FormControl>

              {/* ë‚ ì§œ ì„ íƒ */}
              <Box sx={{ display: 'flex', gap: 2 }}>
                <DatePicker
                  label="ì‹œì‘ì¼"
                  value={requestForm.startDate}
                  onChange={(newValue) =>
                    newValue && setRequestForm((prev) => ({ ...prev, startDate: newValue }))
                  }
                  sx={{ flex: 1 }}
                />
                <DatePicker
                  label="ì¢…ë£Œì¼"
                  value={requestForm.endDate}
                  onChange={(newValue) =>
                    newValue && setRequestForm((prev) => ({ ...prev, endDate: newValue }))
                  }
                  sx={{ flex: 1 }}
                />
              </Box>

              {/* ë°˜ì°¨ ì‚¬ìš© ì²´í¬ë°•ìŠ¤ì™€ ì‹œê°„ ì„ íƒ */}
              <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
                <FormControlLabel
                  control={
                    <Checkbox
                      checked={requestForm.useHalfDay}
                      onChange={(e) => {
                        const checked = e.target.checked;
                        setRequestForm((prev) => ({
                          ...prev,
                          useHalfDay: checked,
                          halfDaySlot: checked ? 'ì˜¤ì „' : '',
                        }));
                      }}
                      color="primary"
                    />
                  }
                  label="ë°˜ì°¨ ì‚¬ìš©"
                />
                {requestForm.useHalfDay && (
                  <FormControl sx={{ minWidth: 120 }}>
                    <InputLabel>ë°˜ì°¨ ì‹œê°„</InputLabel>
                    <Select
                      value={requestForm.halfDaySlot}
                      onChange={(e) => setRequestForm((prev) => ({ ...prev, halfDaySlot: e.target.value }))}
                      label="ë°˜ì°¨ ì‹œê°„"
                    >
                      <MenuItem value="ì˜¤ì „">ì˜¤ì „</MenuItem>
                      <MenuItem value="ì˜¤í›„">ì˜¤í›„</MenuItem>
                    </Select>
                  </FormControl>
                )}
              </Box>

              {/* íœ´ê°€ ì‚¬ìœ  */}
              <TextField
                label="íœ´ê°€ ì‚¬ìœ "
                multiline
                rows={3}
                value={requestForm.reason}
                onChange={(e) => setRequestForm((prev) => ({ ...prev, reason: e.target.value }))}
                placeholder="íœ´ê°€ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                required
              />

              {/* ìŠ¹ì¸ìì™€ ì°¸ì¡°ì í•„ë“œ */}
              <Box sx={{ display: 'flex', gap: 2 }}>
                {/* ìŠ¹ì¸ì ì„ íƒ */}
                <Box sx={{ flex: 1 }}>
                  <Typography sx={{ fontSize: '14px', fontWeight: 600, mb: 1 }}>
                    ìŠ¹ì¸ì
                  </Typography>
                  
                  {/* ìŠ¹ì¸ì ì„ íƒ ë²„íŠ¼ë“¤ */}
                  <Box sx={{ display: 'flex', gap: 1, mb: 1 }}>
                    <Button
                      variant="contained"
                      startIcon={<PeopleIcon />}
                      onClick={() => {
                        setIsSequentialApproval(false);
                        setApproverModalOpen(true);
                      }}
                      sx={{
                        flex: 1,
                        bgcolor: isDark ? '#60A5FA' : '#4A6CF7',
                        '&:hover': { bgcolor: isDark ? '#3B82F6' : '#3B5BE8' },
                      }}
                    >
                      ìŠ¹ì¸ì ì„ íƒ
                    </Button>
                    <Button
                      variant="contained"
                      startIcon={<SequentialIcon />}
                      onClick={() => {
                        setIsSequentialApproval(true);
                        setApproverModalOpen(true);
                      }}
                      sx={{
                        flex: 1,
                        bgcolor: isDark ? '#34D399' : '#10B981',
                        '&:hover': { bgcolor: isDark ? '#10B981' : '#059669' },
                      }}
                    >
                      ìˆœì°¨ê²°ì¬
                    </Button>
                  </Box>

                  <Box
                    onClick={() => setApproverModalOpen(true)}
                    sx={{
                      p: 2,
                      minHeight: 80,
                      borderRadius: '8px',
                      border: `1px solid ${colorScheme.textFieldBorderColor}`,
                      bgcolor: isDark ? 'rgba(255, 255, 255, 0.05)' : '#F8F9FA',
                      cursor: 'pointer',
                      '&:hover': {
                        bgcolor: isDark ? 'rgba(255, 255, 255, 0.08)' : '#F3F4F6',
                      },
                    }}
                  >
                    {requestForm.approverIds.length === 0 ? (
                      <Box sx={{ textAlign: 'center', py: 1 }}>
                        <Typography sx={{ fontSize: '12px', color: colorScheme.hintTextColor }}>
                          {isSequentialApproval ? 'ìˆœì°¨ê²°ì¬ ìŠ¹ì¸ìë¥¼ ì„ íƒí•˜ì„¸ìš”' : 'ìŠ¹ì¸ì ì„ íƒ'}
                        </Typography>
                      </Box>
                    ) : (
                      <Box>
                        <Typography sx={{ fontSize: '12px', fontWeight: 600, mb: 1, color: colorScheme.textColor }}>
                          ì„ íƒëœ ìŠ¹ì¸ì ({requestForm.approverIds.length}ëª…)
                          {isSequentialApproval && ' (ìˆœì°¨ê²°ì¬)'}
                        </Typography>
                        <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5 }}>
                          {requestForm.approverIds.slice(0, 3).map((id, idx) => {
                            const approver = approverList.find((a) => a.approverId === id);
                            return (
                              <Chip
                                key={idx}
                                label={
                                  isSequentialApproval
                                    ? `${idx + 1}. ${approver?.approverName || id}`
                                    : approver?.approverName || id
                                }
                                size="small"
                                sx={{
                                  bgcolor: isSequentialApproval
                                    ? (isDark ? '#10B981' : '#10B981')
                                    : (isDark ? '#60A5FA' : '#1E88E5'),
                                  color: 'white',
                                  fontSize: '10px',
                                  height: 20,
                                }}
                              />
                            );
                          })}
                          {requestForm.approverIds.length > 3 && (
                            <Chip
                              label={`+${requestForm.approverIds.length - 3}`}
                              size="small"
                              sx={{
                                bgcolor: isDark ? 'rgba(96, 165, 250, 0.2)' : 'rgba(30, 136, 229, 0.2)',
                                color: isDark ? '#60A5FA' : '#1E88E5',
                                fontSize: '10px',
                                height: 20,
                              }}
                            />
                          )}
                        </Box>
                      </Box>
                    )}
                  </Box>
                </Box>

                {/* ì°¸ì¡°ì ì„ íƒ */}
                <Box sx={{ flex: 1 }}>
                  <Typography sx={{ fontSize: '14px', fontWeight: 600, mb: 1, color: colorScheme.textColor }}>
                    ì°¸ì¡°ì
                  </Typography>
                  <Box
                    onClick={() => setReferenceModalOpen(true)}
                    sx={{
                      p: 2,
                      minHeight: 80,
                      borderRadius: '8px',
                      border: `1px solid ${colorScheme.textFieldBorderColor}`,
                      bgcolor: isDark ? 'rgba(255, 255, 255, 0.05)' : '#F8F9FA',
                      cursor: 'pointer',
                      '&:hover': {
                        bgcolor: isDark ? 'rgba(255, 255, 255, 0.08)' : '#F3F4F6',
                      },
                    }}
                  >
                    {requestForm.ccList.length === 0 ? (
                      <Box sx={{ textAlign: 'center', py: 1 }}>
                        <Typography sx={{ fontSize: '12px', color: colorScheme.hintTextColor }}>
                          ì°¸ì¡°ì ì„ íƒ
                        </Typography>
                      </Box>
                    ) : (
                      <Box>
                        <Typography sx={{ fontSize: '12px', fontWeight: 600, mb: 1, color: colorScheme.textColor }}>
                          ì„ íƒëœ ì°¸ì¡°ì ({requestForm.ccList.length}ëª…)
                        </Typography>
                        <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5 }}>
                          {requestForm.ccList.slice(0, 2).map((cc, idx) => (
                            <Chip
                              key={idx}
                              label={`${cc.name}(${cc.department})`}
                              size="small"
                              sx={{
                                bgcolor: isDark ? '#34D399' : '#20C997',
                                color: 'white',
                                fontSize: '10px',
                                height: 20,
                              }}
                            />
                          ))}
                          {requestForm.ccList.length > 2 && (
                            <Chip
                              label={`+${requestForm.ccList.length - 2}ëª… ë”`}
                              size="small"
                              sx={{
                                bgcolor: isDark ? 'rgba(52, 211, 153, 0.2)' : 'rgba(32, 201, 151, 0.2)',
                                color: isDark ? '#34D399' : '#20C997',
                                fontSize: '10px',
                                height: 20,
                              }}
                            />
                          )}
                        </Box>
                      </Box>
                    )}
                  </Box>
                </Box>
              </Box>
            </Box>
          </LocalizationProvider>
        </DialogContent>

        <DialogActions sx={{ p: 3 }}>
          <Button onClick={handleRequestDialogClose} variant="outlined">
            ì·¨ì†Œ
          </Button>
          <Button onClick={handleRequestSubmit} variant="contained">
            ì‹ ì²­í•˜ê¸°
          </Button>
        </DialogActions>
      </Dialog>

      {/* íœ´ê°€ ìƒì„¸ ì •ë³´ ë‹¤ì´ì–¼ë¡œê·¸ */}
      <Dialog
        open={detailPanelOpen}
        onClose={() => setDetailPanelOpen(false)}
        maxWidth="sm"
        fullWidth
        PaperProps={{
          sx: {
            bgcolor: colorScheme.surfaceColor,
          },
        }}
      >
        <DialogTitle sx={{ borderBottom: `1px solid ${colorScheme.textFieldBorderColor}`, color: colorScheme.textColor }}>íœ´ê°€ ìƒì„¸ ì •ë³´</DialogTitle>
        <DialogContent>
          {selectedLeaveDetail && (
            <Box sx={{ pt: 2 }}>
              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 2 }}>
                {getStatusIcon(selectedLeaveDetail.status)}
                <Typography variant="h6">{selectedLeaveDetail.leaveType}</Typography>
                <Chip
                  label={
                    selectedLeaveDetail.status === 'APPROVED'
                      ? 'ìŠ¹ì¸'
                      : selectedLeaveDetail.status === 'REJECTED'
                      ? 'ë°˜ë ¤'
                      : 'ëŒ€ê¸°'
                  }
                  color={
                    selectedLeaveDetail.status === 'APPROVED'
                      ? 'success'
                      : selectedLeaveDetail.status === 'REJECTED'
                      ? 'error'
                      : 'warning'
                  }
                  size="small"
                />
              </Box>

              <Divider sx={{ my: 2 }} />

              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1.5 }}>
                <Box>
                  <Typography variant="caption" color="text.secondary">
                    íœ´ê°€ ê¸°ê°„
                  </Typography>
                  <Typography variant="body1">
                    {dayjs(selectedLeaveDetail.startDate).format('YYYY-MM-DD')} ~{' '}
                    {dayjs(selectedLeaveDetail.endDate).format('YYYY-MM-DD')}
                  </Typography>
                </Box>

                <Box>
                  <Typography variant="caption" color="text.secondary">
                    ì‹ ì²­ì¼
                  </Typography>
                  <Typography variant="body1">
                    {dayjs(selectedLeaveDetail.requestedDate).format('YYYY-MM-DD')}
                  </Typography>
                </Box>

                <Box>
                  <Typography variant="caption" color="text.secondary">
                    ì‚¬ìœ 
                  </Typography>
                  <Typography variant="body1">{selectedLeaveDetail.reason}</Typography>
                </Box>

                {selectedLeaveDetail.rejectMessage && (
                  <Alert severity="error" sx={{ mt: 1 }}>
                    ë°˜ë ¤ ì‚¬ìœ : {selectedLeaveDetail.rejectMessage}
                  </Alert>
                )}
              </Box>
            </Box>
          )}
        </DialogContent>
        <DialogActions sx={{ p: 2, gap: 1, justifyContent: 'space-between' }}>
          {selectedLeaveDetail && selectedLeaveDetail.status === 'APPROVED' && (
            <Button
              variant="contained"
              color="warning"
              startIcon={<CancelIcon />}
              onClick={() => {
                setDetailPanelOpen(false);
                setCancelRequestLeave(selectedLeaveDetail);
                setCancelRequestModalOpen(true);
              }}
            >
              ì·¨ì†Œ ìƒì‹ 
            </Button>
          )}
          <Box sx={{ ml: 'auto' }}>
            <Button onClick={() => setDetailPanelOpen(false)} variant="outlined">ë‹«ê¸°</Button>
          </Box>
        </DialogActions>
      </Dialog>

        </Box>
      </Box>

      {/* ì „ì²´íœ´ê°€ ë‹¬ë ¥ ëª¨ë‹¬ */}
      <TotalCalendar
        open={totalCalendarOpen}
        onClose={() => setTotalCalendarOpen(false)}
      />

      {/* ìŠ¹ì¸ì ì„ íƒ ëª¨ë‹¬ */}
      <ApproverSelectionModal
        open={approverModalOpen}
        onClose={() => setApproverModalOpen(false)}
        onConfirm={(selectedIds) => {
          setRequestForm((prev) => ({ ...prev, approverIds: selectedIds }));
        }}
        initialSelectedApproverIds={requestForm.approverIds}
        sequentialApproval={isSequentialApproval}
      />

      {/* ì°¸ì¡°ì ì„ íƒ ëª¨ë‹¬ */}
      <ReferenceSelectionModal
        open={referenceModalOpen}
        onClose={() => setReferenceModalOpen(false)}
        onConfirm={(selectedReferences) => {
          setRequestForm((prev) => ({ ...prev, ccList: selectedReferences }));
        }}
        currentReferences={requestForm.ccList}
      />

      {/* íœ´ê°€ ê´€ë¦¬ ëŒ€ì¥ í¬ê²Œ ë³´ê¸° ëª¨ë‹¬ */}
      <Dialog
        open={managementTableDialogOpen}
        onClose={() => setManagementTableDialogOpen(false)}
        maxWidth="xl"
        fullWidth
        PaperProps={{
          sx: {
            maxHeight: '90vh',
            height: '90vh',
            bgcolor: colorScheme.surfaceColor,
          },
        }}
      >
        <DialogTitle sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', pb: 2, borderBottom: `1px solid ${colorScheme.textFieldBorderColor}` }}>
          <Typography sx={{ fontSize: '18px', fontWeight: 700, color: colorScheme.textColor }}>íœ´ê°€ ê´€ë¦¬ ëŒ€ì¥</Typography>
          <IconButton
            onClick={() => setManagementTableDialogOpen(false)}
            size="small"
            sx={{ p: 0.5 }}
          >
            <ArrowBackIcon />
          </IconButton>
        </DialogTitle>
        <DialogContent sx={{ p: 3, overflow: 'auto' }}>
          <TableContainer sx={{ maxHeight: '100%', overflowX: 'auto' }}>
            <Table size="small" stickyHeader sx={{ borderCollapse: 'separate', minWidth: 800 }}>
              <TableHead>
                <TableRow>
                  <TableCell
                    sx={{
                      fontSize: '12px',
                      fontWeight: 600,
                      bgcolor: isDark ? 'rgba(255, 255, 255, 0.05)' : '#F9FAFB',
                      color: colorScheme.textColor,
                      px: 2,
                      py: 1.5,
                      borderRight: `1px solid ${colorScheme.textFieldBorderColor}`,
                      position: 'sticky',
                      left: 0,
                      zIndex: 3,
                    }}
                  >
                    íœ´ê°€ëª…
                  </TableCell>
                  <TableCell
                    sx={{
                      fontSize: '12px',
                      fontWeight: 600,
                      bgcolor: isDark ? 'rgba(255, 255, 255, 0.05)' : '#F9FAFB',
                      color: colorScheme.textColor,
                      px: 2,
                      py: 1.5,
                      textAlign: 'center',
                    }}
                  >
                    í—ˆìš©ì¼ìˆ˜
                  </TableCell>
                  <TableCell colSpan={12}>
                    <Box sx={{ display: 'flex', flexDirection: 'column', gap: 0.5 }}>
                      <Typography sx={{ fontSize: '12px', fontWeight: 600, textAlign: 'center', color: colorScheme.textColor }}>ì›”ë³„ ì‚¬ìš© í˜„í™©</Typography>
                      <Box sx={{ display: 'flex' }}>
                        {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12].map((month) => (
                          <Box
                            key={month}
                            sx={{
                              flex: 1,
                              fontSize: '11px',
                              fontWeight: 600,
                              textAlign: 'center',
                              px: 1,
                              py: 0.5,
                              color: colorScheme.hintTextColor,
                              borderRight: month < 12 ? `1px solid ${colorScheme.textFieldBorderColor}` : 'none',
                            }}
                          >
                            {month}ì›”
                          </Box>
                        ))}
                      </Box>
                    </Box>
                  </TableCell>
                  <TableCell
                    sx={{
                      fontSize: '12px',
                      fontWeight: 600,
                      bgcolor: isDark ? 'rgba(255, 255, 255, 0.05)' : '#F9FAFB',
                      color: colorScheme.textColor,
                      px: 2,
                      py: 1.5,
                      textAlign: 'center',
                    }}
                  >
                    ì‚¬ìš©ì¼ìˆ˜
                  </TableCell>
                  <TableCell
                    sx={{
                      fontSize: '12px',
                      fontWeight: 600,
                      bgcolor: isDark ? 'rgba(255, 255, 255, 0.05)' : '#F9FAFB',
                      color: colorScheme.textColor,
                      px: 2,
                      py: 1.5,
                      textAlign: 'center',
                    }}
                  >
                    ì”ì—¬ì¼ìˆ˜
                  </TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {tableLoading ? (
                  <TableRow>
                    <TableCell colSpan={16} align="center" sx={{ py: 4 }}>
                      <CircularProgress size={24} />
                    </TableCell>
                  </TableRow>
                ) : managementTableData && managementTableData.length > 0 ? (
                  managementTableData.map((row: any, index: number) => {
                    const allowedDays = row.allowedDays || 0;
                    const totalUsed = row.totalUsed || 0;
                    const remainDays = allowedDays - totalUsed;
                    const usedByMonth = row.usedByMonth || Array(12).fill(0);
                    
                    return (
                      <TableRow
                        key={index}
                        hover
                        sx={{
                          '&:hover': {
                            bgcolor: isDark ? 'rgba(255, 255, 255, 0.05)' : '#F3F4F6',
                            '& .sticky-cell': {
                              bgcolor: isDark ? 'rgba(255, 255, 255, 0.05)' : '#F3F4F6',
                            },
                          },
                        }}
                      >
                        <TableCell
                          className="sticky-cell"
                          sx={{
                            fontSize: '12px',
                            fontWeight: 600,
                            px: 2,
                            py: 1.5,
                            borderRight: `1px solid ${colorScheme.textFieldBorderColor}`,
                            position: 'sticky',
                            left: 0,
                            zIndex: 2,
                            bgcolor: colorScheme.surfaceColor,
                            color: colorScheme.textColor,
                          }}
                        >
                          {row.leaveType || '-'}
                        </TableCell>
                        <TableCell
                          sx={{
                            fontSize: '12px',
                            fontWeight: 600,
                            px: 2,
                            py: 1.5,
                            borderRight: `1px solid ${colorScheme.textFieldBorderColor}`,
                            textAlign: 'center',
                            color: colorScheme.textColor,
                          }}
                        >
                          {allowedDays > 0 ? allowedDays : '-'}
                        </TableCell>
                        {usedByMonth.map((days: number, monthIndex: number) => (
                          <TableCell
                            key={monthIndex}
                            sx={{
                              fontSize: '11px',
                              fontWeight: 600,
                              px: 1,
                              py: 1.5,
                              textAlign: 'center',
                              borderRight: monthIndex < 11 ? `1px solid ${colorScheme.textFieldBorderColor}` : 'none',
                              color: days > 0 ? colorScheme.textColor : colorScheme.hintTextColor,
                            }}
                          >
                            {days > 0 ? days : '-'}
                          </TableCell>
                        ))}
                        <TableCell
                          sx={{
                            fontSize: '12px',
                            fontWeight: 600,
                            px: 2,
                            py: 1.5,
                            borderRight: `1px solid ${colorScheme.textFieldBorderColor}`,
                            textAlign: 'center',
                            color: colorScheme.textColor,
                          }}
                        >
                          {totalUsed > 0 ? totalUsed : '-'}
                        </TableCell>
                        <TableCell
                          sx={{
                            fontSize: '12px',
                            fontWeight: 600,
                            px: 2,
                            py: 1.5,
                            textAlign: 'center',
                            color: remainDays > 0
                              ? (isDark ? '#34D399' : '#059669')
                              : (isDark ? '#F87171' : '#DC2626'),
                          }}
                        >
                          {remainDays}
                        </TableCell>
                      </TableRow>
                    );
                  })
                ) : (
                  <TableRow>
                    <TableCell colSpan={16} align="center" sx={{ py: 4 }}>
                      <Typography sx={{ color: colorScheme.hintTextColor }}>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</Typography>
                    </TableCell>
                  </TableRow>
                )}
              </TableBody>
            </Table>
          </TableContainer>
        </DialogContent>
        <DialogActions sx={{ px: 3, pb: 2 }}>
          <Button onClick={() => setManagementTableDialogOpen(false)} variant="contained">
            ë‹«ê¸°
          </Button>
        </DialogActions>
      </Dialog>

      {/* ì·¨ì†Œ ìƒì‹  í™•ì¸ ëª¨ë‹¬ */}
      <Dialog
        open={cancelRequestModalOpen}
        onClose={() => setCancelRequestModalOpen(false)}
        maxWidth="sm"
        fullWidth
        PaperProps={{
          sx: {
            bgcolor: colorScheme.surfaceColor,
          },
        }}
      >
        <DialogTitle sx={{ pb: 1, borderBottom: `1px solid ${colorScheme.textFieldBorderColor}` }}>
          <Typography variant="h6" sx={{ fontWeight: 600, color: colorScheme.textColor }}>
            ì·¨ì†Œ ìƒì‹  í™•ì¸
          </Typography>
        </DialogTitle>
        <DialogContent sx={{ pb: 2 }}>
          <Box sx={{ mb: 2, mt: 2 }}>
            <Typography sx={{ mb: 2, color: colorScheme.textColor }}>
              ë‹¤ìŒ íœ´ê°€ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?
            </Typography>
            {cancelRequestLeave && (
              <Card sx={{ p: 2, bgcolor: isDark ? 'rgba(255, 255, 255, 0.05)' : '#F9FAFB', border: `1px solid ${colorScheme.textFieldBorderColor}` }}>
                <Typography sx={{ fontSize: '14px', fontWeight: 600, color: colorScheme.textColor, mb: 1 }}>
                  {cancelRequestLeave.leaveType}
                </Typography>
                <Typography sx={{ fontSize: '13px', color: colorScheme.hintTextColor, mb: 1 }}>
                  {dayjs(cancelRequestLeave.startDate).format('YYYY-MM-DD')} ~ {dayjs(cancelRequestLeave.endDate).format('YYYY-MM-DD')}
                </Typography>
                <Typography sx={{ fontSize: '13px', color: colorScheme.hintTextColor }}>
                  {cancelRequestLeave.reason}
                </Typography>
              </Card>
            )}
          </Box>
          <Alert severity="warning" sx={{ mb: 2 }}>
            ì·¨ì†Œ ìƒì‹  í›„ ìŠ¹ì¸ì´ ì™„ë£Œë˜ë©´ í•´ë‹¹ íœ´ê°€ëŠ” ì·¨ì†Œë©ë‹ˆë‹¤.
          </Alert>
        </DialogContent>
        <DialogActions sx={{ px: 3, pb: 2 }}>
          <Button
            onClick={() => {
              setCancelRequestModalOpen(false);
              setCancelRequestLeave(null);
            }}
            variant="outlined"
          >
            ì·¨ì†Œ
          </Button>
          <Button
            onClick={handleCancelRequest}
            variant="contained"
            color="warning"
            startIcon={<CancelIcon />}
          >
            ì·¨ì†Œ ìƒì‹ 
          </Button>
        </DialogActions>
      </Dialog>
    </Box>
  );
}
